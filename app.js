(function(){const has=typeof SUPABASE_URL==='string'&&SUPABASE_URL&&typeof SUPABASE_ANON_KEY==='string'&&SUPABASE_ANON_KEY;const sb=has?window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY):null;const el=id=>document.getElementById(id);const fields={source:el('source'),owner:el('owner'),club:el('club'),person:el('person'),phone:el('phone'),email:el('email'),discipline:el('discipline'),participants:el('participants'),facilities:el('facilities'),date_window:el('date_window'),pref_location:el('pref_location'),status:el('status'),priority:el('priority'),notes:el('notes'),follow_up:el('follow_up'),consent:el('consent')};const chips=document.getElementById('camps');const sel=new Set();chips&&chips.addEventListener('click',e=>{const t=e.target.closest('.chip,input[type=checkbox]');if(!t)return;const v=t.dataset.v||t.getAttribute('data-v');if(t.checked||t.classList.contains('active'))sel.add(v);else sel.delete(v);preview()});const key='tpl_v1';const smsT=el('tpl-sms'),ms=el('tpl-mail-subj'),mb=el('tpl-mail-body');try{const j=JSON.parse(localStorage.getItem(key)||'{}');if(j.sms)smsT.value=j.sms;if(j.ms)ms.value=j.ms;if(j.mb)mb.value=j.mb}catch{} function saveTpl(){localStorage.setItem(key,JSON.stringify({sms:smsT?.value||'',ms:ms?.value||'',mb:mb?.value||''}))}el('dlg-save')?.addEventListener('click',()=>{saveTpl();document.getElementById('dlg').close();preview()});el('dlg-cancel')?.addEventListener('click',()=>document.getElementById('dlg').close());el('templates')?.addEventListener('click',()=>document.getElementById('dlg').showModal());function fill(s){const m={'{CLUB}':fields.club?.value||'klub','{PERSON}':fields.person?.value||'Państwo'};return Object.keys(m).reduce((a,k)=>a.split(k).join(m[k]),s||'')}function mail(){const subj=fill(ms?.value||''),body=fill(mb?.value||''),to=(fields.email?.value||'').trim();return{mailto:`mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`,subj,body}}function sms(){return fill(smsT?.value||'')}function wa(){const p=(fields.phone?.value||'').replace(/\s|-/g,'');const t=encodeURIComponent(sms());return p?`https://wa.me/${p}?text=${t}`:`https://wa.me/?text=${t}`}function preview(){const p=el('preview');if(!p)return;const m=mail();p.textContent=`SMS/WA:\n${sms()}\n\nE‑mail – TEMAT:\n${m.subj}\n\nE‑mail – TREŚĆ:\n${m.body}`}preview();async function save(){if(!fields.club.value.trim()){alert('Podaj Klub/Szkołę');return}const body={source:fields.source.value,owner:fields.owner.value,club:fields.club.value.trim(),person:fields.person.value.trim(),phone:fields.phone.value.trim(),email:fields.email.value.trim(),discipline:fields.discipline.value,participants:fields.participants.value?parseInt(fields.participants.value,10):null,facilities:fields.facilities.value,date_window:fields.date_window.value,pref_location:fields.pref_location.value,camps:Array.from(sel),status:fields.status.value,priority:fields.priority.value,notes:fields.notes.value,consent:fields.consent.value,created_at:new Date().toISOString()};const days=parseInt(fields.follow_up.value||'3',10);const fut=new Date();fut.setDate(fut.getDate()+days);if(has){const {data,error}=await sb.from('leads').insert(body).select('id').single();if(error){alert('Błąd Supabase: '+error.message);return}const id=data.id;await sb.from('followups').insert({lead_id:id,due_at:fut.toISOString(),note:'Auto: follow-up',status:'open'}).catch(()=>{});await sb.from('activities').insert({lead_id:id,text:'Utworzono leada'}).catch(()=>{});return id}else{const k='demo_leads',a=JSON.parse(localStorage.getItem(k)||'[]');const id=a.length?(Math.max(...a.map(r=>Number(r.id)||0))+1):1;a.push({id,...body});localStorage.setItem(k,JSON.stringify(a));return id}}document.getElementById('save-only')?.addEventListener('click',async()=>{const id=await save();if(id)alert('Zapisano #'+id)});document.getElementById('save-and-wa')?.addEventListener('click',async()=>{const id=await save();if(id)window.open(wa(),'_blank','noopener')});document.getElementById('btn-sms')?.addEventListener('click',async()=>{try{await navigator.clipboard.writeText(sms())}catch{}alert('Skopiowano SMS')});document.getElementById('btn-email')?.addEventListener('click',()=>{window.location.href=mail().mailto});document.getElementById('btn-wa')?.addEventListener('click',()=>window.open(wa(),'_blank','noopener'));document.getElementById('reset')?.addEventListener('click',()=>{document.getElementById('contact-form').reset();document.getElementById('contact-meta').reset();Array.from((chips||document).querySelectorAll('.chip,input[type=checkbox]')).forEach(c=>{if(c.checked)c.checked=false});preview()});})();