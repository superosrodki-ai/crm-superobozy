(function(){const has=typeof SUPABASE_URL==='string'&&SUPABASE_URL&&typeof SUPABASE_ANON_KEY==='string'&&SUPABASE_ANON_KEY;const sb=has?window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY):null;const el=id=>document.getElementById(id);const overdue=el('overdue'),today=el('today'),next=el('next');const cO=el('c-over'),cT=el('c-today'),cN=el('c-next');let idx={};async function load(){let f=[],l=[];if(has){const {data:L}=await sb.from('leads').select('id,club,person,owner,phone,email');l=L||[];const {data:F}=await sb.from('followups').select('*').eq('status','open').order('due_at',{ascending:true}).limit(2000);f=F||[]}else{l=JSON.parse(localStorage.getItem('demo_leads')||'[]');f=JSON.parse(localStorage.getItem('superobozy_demo_followups')||'[]').filter(x=>x.status==='open')}idx=Object.fromEntries((l||[]).map(v=>[String(v.id),v]));render(f)}function render(f){const now=new Date();now.setSeconds(0,0);const ts=new Date(now);ts.setHours(0,0,0,0);const te=new Date(ts);te.setDate(te.getDate()+1);const over=[],tod=[],nxt=[];f.forEach(x=>{const d=new Date(x.due_at);if(d<ts)over.push(x);else if(d>=ts&&d<te)tod.push(x);else nxt.push(x)});cO.textContent=String(over.length);cT.textContent=String(tod.length);cN.textContent=String(nxt.length);overdue.innerHTML=over.map(row).join('');today.innerHTML=tod.map(row).join('');next.innerHTML=nxt.map(row).join('')}function row(f){const l=idx[String(f.lead_id)]||{};const who=[l.club||'',l.person||''].filter(Boolean).join(' • ');const contact=[l.email||'',l.phone||''].filter(Boolean).join(' · ');return `<div class="item" data-id="${f.id}" style="display:flex;justify-content:space-between;gap:10px;border-bottom:1px dashed var(--line);padding:8px 4px"><div><div><strong>${who||('Lead #'+f.lead_id)}</strong></div><div class="muted mono" style="font-size:.85rem">${contact}</div><div class="muted" style="font-size:.85rem">${f.note||''}</div></div><div class="mono" style="white-space:nowrap"><div>${new Date(f.due_at).toLocaleString('pl-PL')}</div><div style="text-align:right;margin-top:6px"><button class="btn wa done">✔ zrobione</button></div></div></div>`}document.addEventListener('click',async e=>{const btn=e.target.closest('.done');if(!btn)return;const it=e.target.closest('.item');const id=it?.getAttribute('data-id');if(!id)return;if(has){await sb.from('followups').update({status:'done'}).eq('id',id)}else{const all=JSON.parse(localStorage.getItem('superobozy_demo_followups')||'[]');const i=all.findIndex(x=>String(x.id)===String(id));if(i>=0){all[i].status='done';localStorage.setItem('superobozy_demo_followups',JSON.stringify(all))}}load()});load()})();